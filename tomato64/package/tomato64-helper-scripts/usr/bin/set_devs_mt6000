#!/bin/sh

set -e

. /usr/sbin/nvram_ops
. /usr/sbin/net_utils

# Load kernel modules early to give them time to initialize
if [ "$(NG wed_offloading)" == "1" ]; then
	modprobe mt7915e wed_enable=Y
else
	modprobe mt7915e
fi

modprobe mt7921u

# Wait for ethernet interfaces to be ready
if ! wait_for_interface eth0; then
	logger -t set_devs_mt6000 "ERROR: eth0 did not appear after 10 seconds"
fi

if ! wait_for_interface eth1; then
	logger -t set_devs_mt6000 "ERROR: eth1 did not appear after 10 seconds"
fi

# Wait for DSA switch port interfaces
for p in 1 2 3 4 5; do
	if ! wait_for_interface "lan$p"; then
		logger -t set_devs_mt6000 "WARNING: lan$p did not appear after 10 seconds"
	fi
done

mac=$(ifconfig eth0 | grep -o -E '([[:xdigit:]]{1,2}:){5}[[:xdigit:]]{1,2}')
mac1=$(ifconfig eth1 | grep -o -E '([[:xdigit:]]{1,2}:){5}[[:xdigit:]]{1,2}')

echo "switch0 mac $mac" > /etc/iftab
echo "eth0 mac $mac1" >> /etc/iftab

for p in 1 2 3 4 5
do
	mac=$(increment_mac $mac)
	ip link set dev lan$p address $mac
	echo "eth$p mac $mac" >> /etc/iftab
done
