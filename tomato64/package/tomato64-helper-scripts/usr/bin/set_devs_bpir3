#!/bin/sh

set -e
set -x

. /usr/sbin/nvram_ops
. /usr/sbin/net_utils

# Load kernel modules early to give them time to initialize
modprobe pwm-fan
modprobe aquantia

if [ "$(NG wed_offloading)" == "1" ]; then
	modprobe mt7915e wed_enable=Y
else
	modprobe mt7915e
fi

modprobe mt7921u

# Wait for ethernet interfaces to be ready
if ! wait_for_interface eth0; then
	logger -t set_devs_bpir3 "ERROR: eth0 did not appear after 10 seconds"
fi

if ! wait_for_interface eth1; then
	logger -t set_devs_bpir3 "ERROR: eth1 did not appear after 10 seconds"
fi

if ! wait_for_interface sfp2; then
	logger -t set_devs_bpir3 "WARNING: sfp2 did not appear after 10 seconds"
fi

# Wait for DSA switch port interfaces
for p in wan lan1 lan2 lan3 lan4; do
	if ! wait_for_interface "$p"; then
		logger -t set_devs_bpir3 "WARNING: $p did not appear after 10 seconds"
	fi
done

mac=$(NG eth0macaddr)
if [ -z "$mac" ]; then
	mac=$(ifconfig eth0 | grep -o -E '([[:xdigit:]]{1,2}:){5}[[:xdigit:]]{1,2}')
else
	mac=$(decrement_mac $mac)
fi

echo "switch0 mac $mac" >> /etc/iftab
#ip link set dev switch0 address $mac

mac=$(increment_mac $mac)

echo "eth0 mac $mac" >> /etc/iftab
ip link set dev eth1 address $mac

mac=$(increment_mac $mac)

echo "eth1 mac $mac" >> /etc/iftab
ip link set dev sfp2 address $mac

mac=$(increment_mac $mac)

echo "eth2 mac $mac" >> /etc/iftab
ip link set dev wan address $mac

mac=$(increment_mac $mac)

echo "eth3 mac $mac" >> /etc/iftab
ip link set dev lan1 address $mac
mac=$(increment_mac $mac)

echo "eth4 mac $mac" >> /etc/iftab
ip link set dev lan2 address $mac

mac=$(increment_mac $mac)

echo "eth5 mac $mac" >> /etc/iftab
ip link set dev lan3 address $mac

mac=$(increment_mac $mac)

echo "eth6 mac $mac" >> /etc/iftab
ip link set dev lan4 address $mac
