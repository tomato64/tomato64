#!/bin/sh

set -e
set -x

. /usr/sbin/nvram_ops
. /usr/sbin/net_utils

# Load kernel modules early to give them time to initialize
modprobe mt7921u

# Wait for ethernet interfaces to be ready
# NanoPi R6S has 3 ethernet ports
# eth2 has the constant hardware MAC (RTL8211F PHY on RGMII)
# eth0 and eth1 are derived sequentially from eth2
for p in eth0 eth1 eth2; do
	if ! wait_for_interface "$p"; then
		logger -t set_devs_r6s "ERROR: $p did not appear after 10 seconds"
	fi
done

if [ "$(NG set_macs)" != "1" ]; then

	# eth2 has the constant hardware MAC - use it as base
	eth2macaddr=$(cat /sys/class/net/eth2/address | tr '[:lower:]' '[:upper:]')

	# Derive eth0 and eth1 sequentially (eth0 = base-2, eth1 = base-1, eth2 = base)
	eth0macaddr=$(macaddr_add "$eth2macaddr" -2)
	eth1macaddr=$(macaddr_add "$eth2macaddr" -1)

	NS "eth0macaddr=$eth0macaddr"
	NS "eth1macaddr=$eth1macaddr"
	NS "eth2macaddr=$eth2macaddr"

	# Apply MAC addresses
	ip link set dev eth0 address "$eth0macaddr"
	ip link set dev eth1 address "$eth1macaddr"
	# eth2 already has its hardware MAC, no need to set

	# Set WAN MAC (eth0 is WAN on Tomato64)
	for i in wan_hwaddr wan_mac; do
		NS "${i}=$eth0macaddr"
	done

	# Set LAN MAC (eth1 and eth2 are LAN)
	NS "lan_hwaddr=$eth1macaddr"

	NS set_macs=1

else

	# Apply stored MAC addresses
	ip link set dev eth0 address "$(NG eth0macaddr)"
	ip link set dev eth1 address "$(NG eth1macaddr)"
	# eth2 already has its hardware MAC, no need to set

fi
