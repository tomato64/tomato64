From fd09614faa4c9406b6f23bebcf31cd943d4be4ab Mon Sep 17 00:00:00 2001
From: lancethepants <lancethepants@gmail.com>
Date: Tue, 3 Feb 2026 22:45:02 -0700
Subject: [PATCH] Use Tomato64 bridge option to assign wireless interfaces to
 bridges

---
 .../usr/share/schema/wireless.wifi-iface.json |  4 ++++
 .../files/lib/netifd/wireless-device.uc       | 20 ++++++++++++++++---
 2 files changed, 21 insertions(+), 3 deletions(-)

diff --git a/package/network/config/wifi-scripts/files-ucode/usr/share/schema/wireless.wifi-iface.json b/package/network/config/wifi-scripts/files-ucode/usr/share/schema/wireless.wifi-iface.json
index f5507305bd..a10aa7a48c 100644
--- a/package/network/config/wifi-scripts/files-ucode/usr/share/schema/wireless.wifi-iface.json
+++ b/package/network/config/wifi-scripts/files-ucode/usr/share/schema/wireless.wifi-iface.json
@@ -188,6 +188,10 @@
 		"bssid_whitelist": {
 			"type": "array"
 		},
+		"bridge": {
+			"description": "Direct bridge interface name to join (e.g. br0). Used when network interface lookup is not available.",
+			"type": "string"
+		},
 		"ca_cert": {
 			"description": "Specifies the path the CA certificate used for authentication",
 			"type": "string"
diff --git a/package/network/config/wifi-scripts/files/lib/netifd/wireless-device.uc b/package/network/config/wifi-scripts/files/lib/netifd/wireless-device.uc
index 428db6ee6a..b9a60b8493 100644
--- a/package/network/config/wifi-scripts/files/lib/netifd/wireless-device.uc
+++ b/package/network/config/wifi-scripts/files/lib/netifd/wireless-device.uc
@@ -123,9 +123,14 @@ function wdev_config_init(wdev)
 			vlans, stas,
 		};
 
-		for (let net in vif.config.network)
-			if (netifd.interface_get_bridge(net, iface))
-				break;
+//		for (let net in vif.config.network)
+//			if (netifd.interface_get_bridge(net, iface))
+//				break;
+
+		if (vif.config.bridge) {
+			iface.bridge = vif.config.bridge;
+			iface['bridge-ifname'] = vif.config.bridge;
+		}
 	}
 
 	wdev.handler_config = {
@@ -356,6 +361,15 @@ function wdev_update_disabled_vifs(wdev)
 			cache[name] = ifindex;
 		else
 			delete cache[name];
+
+		/* Tomato64: Detect bridge config changes */
+		let bridge_cache_key = name + "_bridge";
+		if (vif.config.bridge != cache[bridge_cache_key])
+			changed = true;
+		if (vif.config.bridge)
+			cache[bridge_cache_key] = vif.config.bridge;
+		else
+			delete cache[bridge_cache_key];
 	}
 
 	if (changed || !is_equal(prev_disabled, disabled))
-- 
2.47.3

